include "../core_timed_defs.csp"

channel terminate
	
channel followFlightPlan: SearchType
channel WatchForAbnormalities: Bool

channel setwAbnormalities: Bool
channel getwAbnormalities: Bool

channel setSearchType: SearchType
channel getSearchType: SearchType


datatype SearchType = SearchType_AreaSearch | SearchType_RapidParallelLine | SearchType_Linear | SearchType_CreepingLine | SearchType_PointOfInterest | SearchType_MountainFace | SearchType_WoodedArea | SearchType_Avalanche

-- declaring identifiers of fragments
datatype IDS = 
              ID_ALT  | 
              ID_LOOP | 
              ID_PAR | 
              ID_STR |
              ID_OPT

channel guard: IDS.core_int.core_int.Bool
channel alt: IDS.core_int
channel loop: IDS.core_int
channel par: IDS.core_int
channel str: IDS.core_int
channel opt: IDS.core_int

nametype core_int = {0..5}

Timed(OneStep) { 
	Opt = timed_priority((((Pilot [| diff(inter(A_Pilot,A_Handheld),gets) |] Handheld) [| {|opt,guard,terminate|} |] guards) [| union(sharedVars, {terminate}) |] varMemory )) \{|guard,opt|}

	Pilot = WatchForAbnormalities?wAbnormalities ->
	 (setwAbnormalities!wAbnormalities -> SKIP); Opt_Pilot_1; terminate -> SKIP
	
	Handheld = Opt_Handheld_1; terminate -> SKIP

	Opt_Pilot_1 = opt.ID_OPT.1  -> SKIP; guard.ID_OPT.1.1?x -> (
	(x)&(followFlightPlan!SearchType_RapidParallelLine -> SKIP)
	[]
	(not(x))&(SKIP))
	
	Opt_Handheld_1 = opt.ID_OPT.1 -> SKIP; guard.ID_OPT.1.1?x -> (
	(x)&( 	
	(followFlightPlan?searchType -> 
	(setSearchType!searchType -> SKIP)))
	[]
	(not(x))&(SKIP))
		
	guards = (evaluation [| union(A_Counters, {|terminate|}) |] counters) \countVars
	
	evaluation = reset_counters; guards_response
	
	counters = terminate -> SKIP
	
	reset_counters = SKIP
	
	
	guards_response = opt?ID_OPT.x -> ((x==1)&(getwAbnormalities?wAbnormalities -> (
		((wAbnormalities == false))&(guard.ID_OPT.1.1!true -> SKIP)
		[] not((wAbnormalities == false))&(guard.ID_OPT.1.1!false -> SKIP)))); guards_response
			[] terminate -> SKIP
	
	

	
	
	varMemory = Memory_searchType(SearchType_AreaSearch)
					 [| { terminate } |]
					 Memory_wAbnormalities(false)

	Memory_searchType(searchType) =
				getSearchType!searchType -> Memory_searchType(searchType)
				[]
				setSearchType?x__ -> Memory_searchType(x__)
				[]
				terminate -> SKIP
				
				
	Memory_wAbnormalities(wAbnormalities) =
				getwAbnormalities!wAbnormalities -> Memory_wAbnormalities(wAbnormalities)
				[]
				setwAbnormalities?x__ -> Memory_wAbnormalities(x__)
				[]
				terminate -> SKIP
}

A_Pilot = union(union({|WatchForAbnormalities, followFlightPlan, terminate, guard.ID_OPT.1.1,opt.ID_OPT.1|},searchTypeVars),wAbnormalitiesVars)

A_Handheld = {|followFlightPlan,terminate,guard.ID_OPT.1.1,opt.ID_OPT.1|}

A_Counters = countVars
countVars = {||}

sharedVars = union(searchTypeVars,wAbnormalitiesVars)

searchTypeVars = {|setSearchType,getSearchType|}
wAbnormalitiesVars = {|getwAbnormalities,setwAbnormalities|}

gets = {|getwAbnormalities,getSearchType|}


assert not Opt :[deadlock free]
assert Opt :[divergence free]
assert Opt :[deterministic]
assert Opt :[has trace [T]]: <WatchForAbnormalities.false,setwAbnormalities.false,getwAbnormalities.false,followFlightPlan.SearchType_RapidParallelLine,setSearchType.SearchType_RapidParallelLine,terminate>
assert Opt :[has trace [T]]: <WatchForAbnormalities.true,setwAbnormalities.true,getwAbnormalities.true,terminate>

